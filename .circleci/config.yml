version: 2.1
workflows:
  version: 2
  build_deploy_test:
    jobs:
     #### These jobs depend on the following variables being set globally
     #### In CircleCI configuration.
     # TERMINUS_SITE (The machine name of the Gatsby Site on Pantheon. Not the source WordPress or Drupal site.)
     # TERMINUS_TOKEN (https://pantheon.io/docs/machine-tokens, allows for the creation of Multidev Environments)
     # GCP_SA (The GCP security token that allows for syncing to the GCP Object storage bucket)
     #### This repo (stevector/stevector-gatsby) also has project-specific variables for Drupal authentication.
     # GATSBY_DRUPAL_PASSWORD
     # GATSBY_DRUPAL_USER
      - pfe/gatsby-build-and-deploy:
         # trying to get the build to break with example.com
         data-source-url: "live-stevector-drupal.pantheonsite.io"
         deployment-path: "nested-example/site"
         resource-class: "small"
         pre-steps:
            - pfe/set-terminus-env 

         post-steps:
            - run:
                name: 404 and redirects
                command: |
                  if [[ -f ./public/404.html ]]; then
                    gsutil cp ./public/404.html gs://static.pantheonfrontend.website/${TERMINUS_SITE}/${TERMINUS_ENV}/
                    gsutil setmeta -h "Cache-Control:public, s-maxage=10, stale-while-revalidate=600" gs://static.pantheonfrontend.website/${TERMINUS_SITE}/${TERMINUS_ENV}/404.html
                  fi
                  
                  if [[ -f ./public/redirects.json ]]; then
                    gsutil cp ./public/redirects.json gs://static.pantheonfrontend.website/${TERMINUS_SITE}/${TERMINUS_ENV}/
                    gsutil setmeta -h "Cache-Control:public, s-maxage=10, stale-while-revalidate=600" gs://static.pantheonfrontend.website/${TERMINUS_SITE}/${TERMINUS_ENV}/redirects.json
                  fi         
         
            - run:
                name: post deployment completion status
                command: |
                 curl "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/statuses/$CIRCLE_SHA1" -H "Authorization: token $GITHUB_TOKEN" -X POST -d '{"state": "success", "context": "pantheon/deployment", "description": "Deployment complete", "target_url": "https://'${TERMINUS_ENV}'--'${TERMINUS_SITE}'.my.pantheonfrontend.website/nested-example/site"}'

            - slack/notify:
                # image_url: "https://pantheon.io/sites/all/themes/zeus/images/pantheon-OG-backup.png"
                include_job_number_field: false
                include_visit_job_action: false
                title: "Pull Request $TERMINUS_ENV has been deployed"
                title_link: "https://${TERMINUS_ENV}--${TERMINUS_SITE}.my.pantheonfrontend.website/nested-example/site"
                #channel: CHANNELID
                #color: '#42e2f4'
                #mentions: 'USERID1,USERID2,'
                message: "Preview your changes on Pantheon"

orbs:
  pfe: pantheon-systems/front-end@dev:selective-caching
  slack: circleci/slack@3.4.2
  # pfe: stevector/pantheon-frontend@dev:orb-params
